name: 'OpenCache Deploy'
description: 'Deploy Nix store paths to an OpenCache instance'

inputs:
  paths:
    description: 'Newline-separated Nix store paths to deploy (standalone mode, without save/restore)'
    required: false
  paths-file:
    description: 'Path to a file containing store paths (e.g. from the restore action)'
    required: false
  export-dir:
    description: 'Path to a nix binary cache export directory (from restore action). When set, paths are copied from this store instead of the local nix store.'
    required: false
  snapshot-path:
    description: 'Path to the store snapshot file from the setup action. When set (and paths/paths-file are omitted), new store paths are auto-detected by diffing the nix store.'
    required: false
    default: ''
  store-dir:
    description: 'Path to the Nix store directory (used for auto-detection)'
    required: false
    default: '/nix/store'
  magic-nix-cache-addr:
    description: 'Address of a running magic-nix-cache daemon (e.g. 127.0.0.1:37515). When set, new store paths are discovered by querying the daemon and then deployed to OpenCache.'
    required: false
    default: ''
  backend:
    description: 'Storage backend: github-releases, s3, or local'
    required: false
    default: 'github-releases'
  github-token:
    description: 'GitHub token (required for github-releases backend)'
    required: false
  github-owner:
    description: 'GitHub repository owner (defaults to current repository owner)'
    required: false
  github-repo:
    description: 'GitHub repository name (defaults to current repository name)'
    required: false
  github-release-tag:
    description: 'GitHub release tag for NAR storage'
    required: false
    default: 'nix-cache'
  signing-key:
    description: 'Nix signing key (keyname:base64-ed25519-private)'
    required: false
  upload-secret:
    description: 'Bearer token for upload authentication'
    required: false
  static:
    description: 'Output directory for static site generation (omit to skip)'
    required: false
  port:
    description: 'Port for the temporary OpenCache server'
    required: false
    default: '18734'
  compression:
    description: 'Compression type for nix copy (none, xz, zstd)'
    required: false
    default: 'none'

runs:
  using: composite
  steps:
    - name: Resolve store paths
      id: prepare
      shell: bash
      env:
        INPUT_PATHS: ${{ inputs.paths }}
        INPUT_PATHS_FILE: ${{ inputs.paths-file }}
        SNAPSHOT_PATH: ${{ inputs.snapshot-path }}
        STORE_DIR: ${{ inputs.store-dir }}
        MNC_ADDR: ${{ inputs.magic-nix-cache-addr }}
      run: |
        set -euo pipefail
        PATHS_FILE="/tmp/opencache-deploy-paths.txt"

        if [ -n "$INPUT_PATHS_FILE" ] && [ -f "$INPUT_PATHS_FILE" ]; then
          cp "$INPUT_PATHS_FILE" "$PATHS_FILE"
        elif [ -n "$INPUT_PATHS" ]; then
          echo "$INPUT_PATHS" | sed '/^$/d' > "$PATHS_FILE"
        elif [ -n "$SNAPSHOT_PATH" ] && [ -f "$SNAPSHOT_PATH" ]; then
          # Auto-detect new paths by diffing the store
          echo "Auto-detecting new store paths..."
          CURRENT_PATHS=$(mktemp)
          find "$STORE_DIR" -maxdepth 1 -mindepth 1 \
            -not -name '.links' \
            -not -name '*.drv' \
            -not -name '*.chroot' \
            | sort > "$CURRENT_PATHS"
          comm -23 "$CURRENT_PATHS" "$SNAPSHOT_PATH" > "$PATHS_FILE"
          rm -f "$CURRENT_PATHS"
        elif [ -n "$MNC_ADDR" ]; then
          # Discover paths from magic-nix-cache - the daemon tracks new paths
          # automatically, so we just need to ask it to finish and we push from
          # the local store
          echo "Discovering paths from magic-nix-cache at $MNC_ADDR..."
          if ! RESPONSE=$(curl -sf -X POST "http://${MNC_ADDR}/api/workflow-finish" 2>&1); then
            echo "::warning::Could not reach magic-nix-cache at $MNC_ADDR: $RESPONSE"
          else
            NUM_NEW=$(echo "$RESPONSE" | grep -o '"num_new_paths":[0-9]*' | grep -o '[0-9]*' || echo "unknown")
            echo "magic-nix-cache reported $NUM_NEW new path(s)"
          fi

          if [ -n "$SNAPSHOT_PATH" ] && [ -f "$SNAPSHOT_PATH" ]; then
            # Use snapshot for accurate diffing when available
            echo "Diffing store against snapshot..."
            CURRENT_PATHS=$(mktemp)
            find "$STORE_DIR" -maxdepth 1 -mindepth 1 \
              -not -name '.links' \
              -not -name '*.drv' \
              -not -name '*.chroot' \
              | sort > "$CURRENT_PATHS"
            comm -23 "$CURRENT_PATHS" "$SNAPSHOT_PATH" > "$PATHS_FILE"
            rm -f "$CURRENT_PATHS"
          else
            echo "::warning::No store snapshot found; all current store paths will be deployed. Use the setup action for accurate diffing."
            find "$STORE_DIR" -maxdepth 1 -mindepth 1 \
              -not -name '.links' \
              -not -name '*.drv' \
              -not -name '*.chroot' \
              | sort > "$PATHS_FILE"
          fi
        else
          echo "::error::One of 'paths', 'paths-file', 'snapshot-path', or 'magic-nix-cache-addr' is required"
          exit 1
        fi

        count=$(wc -l < "$PATHS_FILE")
        echo "Will deploy $count store path(s)"
        echo "paths-file=$PATHS_FILE" >> "$GITHUB_OUTPUT"

    - name: Install OpenCache
      id: install
      shell: bash
      run: |
        set -euo pipefail
        OPENCACHE_DIR="${{ github.action_path }}/.."
        cd "$OPENCACHE_DIR"
        npm ci --ignore-scripts --silent
        echo "opencache-dir=$(cd "$OPENCACHE_DIR" && pwd)" >> "$GITHUB_OUTPUT"

    - name: Start OpenCache server
      id: server
      shell: bash
      env:
        STORAGE_BACKEND: ${{ inputs.backend }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GITHUB_OWNER: ${{ inputs.github-owner }}
        GITHUB_REPO: ${{ inputs.github-repo }}
        GITHUB_RELEASE_TAG: ${{ inputs.github-release-tag }}
        SIGNING_KEY: ${{ inputs.signing-key }}
        UPLOAD_SECRET: ${{ inputs.upload-secret }}
        PORT: ${{ inputs.port }}
        OPENCACHE_DIR: ${{ steps.install.outputs.opencache-dir }}
      run: |
        set -euo pipefail

        # Default owner/repo to current repository if not provided
        export GITHUB_OWNER="${GITHUB_OWNER:-${{ github.repository_owner }}}"
        export GITHUB_REPO="${GITHUB_REPO:-${{ github.event.repository.name }}}"

        node "$OPENCACHE_DIR/index.js" > /tmp/opencache-deploy.log 2>&1 &
        SERVER_PID=$!
        echo "server-pid=$SERVER_PID" >> "$GITHUB_OUTPUT"

        # Wait for server to be ready
        for i in $(seq 1 30); do
          if curl -sf "http://localhost:${PORT}/nix-cache-info" > /dev/null 2>&1; then
            echo "OpenCache server ready on port $PORT"
            break
          fi
          if ! kill -0 "$SERVER_PID" 2>/dev/null; then
            echo "::error::OpenCache server exited unexpectedly"
            cat /tmp/opencache-deploy.log
            exit 1
          fi
          sleep 1
        done

    - name: Push store paths
      shell: bash
      env:
        EXPORT_DIR: ${{ inputs.export-dir }}
        PORT: ${{ inputs.port }}
        COMPRESSION: ${{ inputs.compression }}
      run: |
        set -euo pipefail
        PATHS_FILE="${{ steps.prepare.outputs.paths-file }}"

        copy_args=()
        if [ -n "$EXPORT_DIR" ] && [ -d "$EXPORT_DIR" ]; then
          copy_args+=(--from "file://$EXPORT_DIR")
          echo "Copying from exported binary cache: $EXPORT_DIR"
        fi

        while IFS= read -r p; do
          [ -z "$p" ] && continue
          echo "Pushing: $p"
          nix copy "${copy_args[@]}" --to "http://localhost:${PORT}?compression=${COMPRESSION}" --no-check-sigs "$p"
        done < "$PATHS_FILE"

    - name: Generate static site
      if: inputs.static != ''
      shell: bash
      env:
        GITHUB_OWNER: ${{ inputs.github-owner }}
        GITHUB_REPO: ${{ inputs.github-repo }}
        GITHUB_RELEASE_TAG: ${{ inputs.github-release-tag }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
        OUTPUT_DIR: ${{ inputs.static }}
        OPENCACHE_DIR: ${{ steps.install.outputs.opencache-dir }}
      run: |
        set -euo pipefail
        export GITHUB_OWNER="${GITHUB_OWNER:-${{ github.repository_owner }}}"
        export GITHUB_REPO="${GITHUB_REPO:-${{ github.event.repository.name }}}"
        node "$OPENCACHE_DIR/generate-static.js"

    - name: Stop OpenCache server
      if: always()
      shell: bash
      run: kill "${{ steps.server.outputs.server-pid }}" 2>/dev/null || true

    - name: Upload server logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: opencache-deploy-log
        path: /tmp/opencache-deploy.log
        retention-days: 7
